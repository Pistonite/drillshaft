diff --git a/lua/claudecode/diff.lua b/lua/claudecode/diff.lua
index 7e1b8f0..347b71c 100644
--- a/lua/claudecode/diff.lua
+++ b/lua/claudecode/diff.lua
@@ -243,7 +243,7 @@ local function display_terminal_in_new_tab()
 
   local terminal_config = config.terminal or {}
   local split_side = terminal_config.split_side or "right"
-  local split_width = terminal_config.split_width_percentage or 0.30
+  -- local split_width = terminal_config.split_width_percentage or 0.30
 
   -- Optionally hide the Claude terminal in the new tab for more review space
   local hide_in_new_tab = false
@@ -284,7 +284,7 @@ local function display_terminal_in_new_tab()
   })
 
   local total_width = vim.o.columns
-  local terminal_width = math.floor(total_width * split_width)
+  -- local terminal_width = math.floor(total_width * split_width)
   vim.api.nvim_win_set_width(terminal_win, terminal_width)
 
   vim.cmd("wincmd " .. (split_side == "right" and "h" or "l"))
@@ -549,15 +549,128 @@ local function load_original_buffer(original_win, old_file_path, is_new_file, ex
   return vim.api.nvim_win_get_buf(original_win)
 end
 
----Create the proposed side split, set diff, filetype, context, and terminal focus/width
----@param original_win NvimWin
----@param original_buf NvimBuf
----@param new_buf NvimBuf
----@param old_file_path string
----@param tab_name string
----@param terminal_win_in_new_tab NvimWin|nil
----@param target_win_for_meta NvimWin
----@return NvimWin new_win
+---@type table|nil Latest diff state for codediff.nvim integration
+---@field proposed_path string Path to the proposed temp file
+---@field tab_name string The diff identifier
+---@field old_file_path string The actual file path being diffed
+local latest_diff = nil
+
+---@type number|nil Window ID for the notification floating window
+local notification_win = nil
+---@type number|nil Buffer ID for the notification floating window
+local notification_buf = nil
+
+---Dismiss the notification floating window if it exists
+function M.dismiss_notification()
+  if notification_win and vim.api.nvim_win_is_valid(notification_win) then
+    pcall(vim.api.nvim_win_close, notification_win, true)
+  end
+  if notification_buf and vim.api.nvim_buf_is_valid(notification_buf) then
+    pcall(vim.api.nvim_buf_delete, notification_buf, { force = true })
+  end
+  notification_win = nil
+  notification_buf = nil
+end
+
+---Show a notification floating window at the bottom left corner
+---@param message string The message to display
+local function show_notification(message)
+  -- Dismiss any existing notification first
+  M.dismiss_notification()
+
+  -- Calculate dimensions: 30 characters wide, 8 lines tall
+  local screen_height = vim.o.lines
+  local win_width = 28
+  local win_height = 4
+
+  -- Position at bottom left, 1 line from the bottom
+  local row = screen_height - win_height - 3
+  local col = 0
+
+  -- Create buffer for the notification
+  notification_buf = vim.api.nvim_create_buf(false, true)
+  if not notification_buf or notification_buf == 0 then
+    return
+  end
+
+  -- Set buffer options
+  vim.bo[notification_buf].buftype = "nofile"
+  vim.bo[notification_buf].bufhidden = "wipe"
+  vim.bo[notification_buf].swapfile = false
+  vim.bo[notification_buf].filetype = "claude-notify"
+
+  -- Wrap the message to fit the window width
+  local lines = {}
+  local words = {}
+  for word in message:gmatch("%S+") do
+    table.insert(words, word)
+  end
+
+  local current_line = ""
+  for _, word in ipairs(words) do
+    if #current_line + #word + 1 <= win_width - 2 then
+      if current_line == "" then
+        current_line = word
+      else
+        current_line = current_line .. " " .. word
+      end
+    else
+      if current_line ~= "" then
+        table.insert(lines, " " .. current_line)
+      end
+      current_line = word
+    end
+  end
+  if current_line ~= "" then
+    table.insert(lines, " " .. current_line)
+  end
+
+  -- Pad with empty lines if needed
+  while #lines < win_height do
+    table.insert(lines, "")
+  end
+
+  vim.api.nvim_buf_set_lines(notification_buf, 0, -1, false, lines)
+  vim.api.nvim_buf_set_option(notification_buf, "modifiable", false)
+
+  -- Create the floating window
+  notification_win = vim.api.nvim_open_win(notification_buf, false, {
+    relative = "editor",
+    width = win_width,
+    height = win_height,
+    row = row,
+    col = col,
+    style = "minimal",
+    border = "rounded",
+    focusable = false,
+  })
+
+  if notification_win and vim.api.nvim_win_is_valid(notification_win) then
+    -- Create highlight group for notification with custom foreground color
+    vim.api.nvim_set_hl(0, "ClaudeCodeNotification", { fg = "#f9e2af" })
+    vim.api.nvim_set_hl(0, "ClaudeCodeNotificationBorder", { fg = "#f9e2af" })
+
+    -- Set window options for better visibility
+    vim.api.nvim_win_set_option(notification_win, "winblend", 0)
+    vim.api.nvim_win_set_option(
+      notification_win,
+      "winhighlight",
+      "Normal:ClaudeCodeNotification,FloatBorder:ClaudeCodeNotificationBorder"
+    )
+  end
+end
+
+---Save original and proposed files to ~/.vim/claude for codediff.nvim integration
+---Does NOT open diff view immediately - use ClaudeCodeOpenCodeDiff for that
+---@param original_win NvimWin (unused, kept for compatibility)
+---@param original_buf NvimBuf (unused, kept for compatibility)
+---@param new_buf NvimBuf Buffer containing the proposed changes
+---@param old_file_path string Path to the original file
+---@param tab_name string The diff identifier
+---@param terminal_win_in_new_tab NvimWin|nil (unused, kept for compatibility)
+---@param target_win_for_meta NvimWin (unused, kept for compatibility)
+---@return boolean success Whether the files were saved successfully
+---@return string|nil error Error message if failed
 local function setup_new_buffer(
   original_win,
   original_buf,
@@ -567,68 +680,60 @@ local function setup_new_buffer(
   terminal_win_in_new_tab,
   target_win_for_meta
 )
-  vim.api.nvim_set_current_win(original_win)
-  vim.cmd("diffthis")
+  -- Suppress unused variable warnings
+  local _ = original_win and original_buf and terminal_win_in_new_tab and target_win_for_meta
 
-  create_split()
-  local new_win = vim.api.nvim_get_current_win()
-  vim.api.nvim_win_set_buf(new_win, new_buf)
-
-  local original_ft = detect_filetype(old_file_path, original_buf)
-  if original_ft and original_ft ~= "" then
-    vim.api.nvim_set_option_value("filetype", original_ft, { buf = new_buf })
+  local dir, dir_err = M.get_claude_diff_dir()
+  if not dir then
+    return false, dir_err
   end
-  vim.cmd("diffthis")
 
-  vim.cmd("wincmd =")
-
-  vim.api.nvim_set_current_win(new_win)
-
-  vim.b[new_buf].claudecode_diff_tab_name = tab_name
-  vim.b[new_buf].claudecode_diff_new_win = new_win
-  vim.b[new_buf].claudecode_diff_target_win = target_win_for_meta
+  -- Compute proposed file path based on original file path
+  -- Replace path separators and other problematic characters to avoid nested directories
+  local sanitized_name = old_file_path:gsub("[/\\:*?\"<>|]", "_")
+  local timestamp = os.time()
+  local proposed_path = dir .. sanitized_name .. "_" .. timestamp .. ".claude-proposed"
+
+  -- Get proposed content from buffer
+  local new_lines = vim.api.nvim_buf_get_lines(new_buf, 0, -1, false)
+  local new_content = table.concat(new_lines, "\n")
+  if #new_lines > 0 then
+    new_content = new_content .. "\n"
+  end
 
-  if config and config.diff_opts and config.diff_opts.keep_terminal_focus then
-    vim.schedule(function()
-      if terminal_win_in_new_tab and vim.api.nvim_win_is_valid(terminal_win_in_new_tab) then
-        vim.api.nvim_set_current_win(terminal_win_in_new_tab)
-        vim.cmd("startinsert")
-        return
-      end
+  -- Write proposed file
+  local prop_file = io.open(proposed_path, "w")
+  if not prop_file then
+    return false, "Failed to write proposed file to " .. proposed_path
+  end
+  prop_file:write(new_content)
+  prop_file:close()
 
-      local terminal_win = find_claudecode_terminal_window()
-      if terminal_win then
-        vim.api.nvim_set_current_win(terminal_win)
-        vim.cmd("startinsert")
-      end
-    end)
+  -- Delete the proposed buffer now that we've saved its contents
+  if new_buf and vim.api.nvim_buf_is_valid(new_buf) then
+    pcall(vim.api.nvim_buf_delete, new_buf, { force = true })
   end
 
-  if terminal_win_in_new_tab and vim.api.nvim_win_is_valid(terminal_win_in_new_tab) then
-    local terminal_config = config.terminal or {}
-    local split_width = terminal_config.split_width_percentage or 0.30
-    local total_width = vim.o.columns
-    local terminal_width = math.floor(total_width * split_width)
-    vim.api.nvim_win_set_width(terminal_win_in_new_tab, terminal_width)
-  else
-    local terminal_win = find_claudecode_terminal_window()
-    if terminal_win and vim.api.nvim_win_is_valid(terminal_win) then
-      local current_tab = vim.api.nvim_get_current_tabpage()
-      local term_tab = nil
-      pcall(function()
-        term_tab = vim.api.nvim_win_get_tabpage(terminal_win)
-      end)
-      if term_tab == current_tab then
-        local terminal_config = config.terminal or {}
-        local split_width = terminal_config.split_width_percentage or 0.30
-        local total_width = vim.o.columns
-        local terminal_width = math.floor(total_width * split_width)
-        pcall(vim.api.nvim_win_set_width, terminal_win, terminal_width)
-      end
+  -- Store latest diff state
+  latest_diff = {
+    proposed_path = proposed_path,
+    tab_name = tab_name,
+    old_file_path = old_file_path,
+  }
+
+    local editorapi = require("piston.editorapi")
+    if editorapi.aicoder_check_auto_open_diff() then
+        -- open diff
+        vim.defer_fn(M.open_code_diff, 200)
+        M.dismiss_notification()
+    else
+        -- Show notification about the new diff
+        show_notification("aidiff available! <leader>bv to view")
     end
-  end
 
-  return new_win
+  logger.debug("diff", "Saved diff files to " .. dir .. " for tab: " .. tab_name)
+
+  return true, nil
 end
 
 ---Open diff using native Neovim functionality
@@ -702,6 +807,29 @@ end
 ---@type table<string, table>
 local active_diffs = {}
 
+
+---Get the ~/.vim/claude directory, creating it if needed
+---@return string|nil path The directory path, or nil on error
+---@return string|nil error Error message if failed
+function M.get_claude_diff_dir()
+  local home = os.getenv("HOME") or os.getenv("USERPROFILE")
+  if not home then
+    return nil, "Could not determine HOME or USERPROFILE directory"
+  end
+
+  local dir = vim.fn.stdpath("data") .. "/piston/aicoder"
+  local stat = vim.loop.fs_stat(dir)
+
+  if not stat then
+    local ok, err = pcall(vim.fn.mkdir, dir, "p")
+    if not ok then
+      return nil, "Failed to create directory " .. dir .. ": " .. tostring(err)
+    end
+  end
+
+  return dir, nil
+end
+
 ---Register diff state for tracking
 ---@param tab_name string Unique identifier for the diff
 ---@param diff_data table Diff state data
@@ -710,26 +838,37 @@ function M._register_diff_state(tab_name, diff_data)
 end
 
 ---Resolve diff as saved (user accepted changes)
+---Reads the proposed content from the temp file in ~/.vim/claude
 ---@param tab_name string The diff identifier
----@param buffer_id number The buffer that was saved
-function M._resolve_diff_as_saved(tab_name, buffer_id)
+function M._resolve_diff_as_saved(tab_name)
   local diff_data = active_diffs[tab_name]
   if not diff_data or diff_data.status ~= "pending" then
     return
   end
 
+  -- Auto-dismiss notification when accepting
+  M.dismiss_notification()
+
   logger.debug("diff", "Accepting diff for", tab_name)
 
-  -- Get content from buffer
-  local content_lines = vim.api.nvim_buf_get_lines(buffer_id, 0, -1, false)
+  -- Read content from the proposed temp file (user may have edited it in codediff)
+  if not latest_diff or not latest_diff.proposed_path then
+    logger.error("diff", "No proposed file path available")
+    return
+  end
+
+  local proposed_path = latest_diff.proposed_path
+  if vim.fn.filereadable(proposed_path) ~= 1 then
+    logger.error("diff", "Proposed file not readable:", proposed_path)
+    return
+  end
+
+  local content_lines = vim.fn.readfile(proposed_path)
   local final_content = table.concat(content_lines, "\n")
-  -- Add trailing newline if the buffer has one
-  if #content_lines > 0 and vim.api.nvim_buf_get_option(buffer_id, "eol") then
+  if #content_lines > 0 then
     final_content = final_content .. "\n"
   end
 
-  -- Do not modify windows/tabs here; wait for explicit close_tab tool call to clean up UI
-
   -- Create MCP-compliant response
   local result = {
     content = {
@@ -805,6 +944,9 @@ function M._resolve_diff_as_rejected(tab_name)
     return
   end
 
+  -- Auto-dismiss notification when rejecting
+  M.dismiss_notification()
+
   -- Create MCP-compliant response
   local result = {
     content = {
@@ -839,45 +981,45 @@ end
 local function register_diff_autocmds(tab_name, new_buffer)
   local autocmd_ids = {}
 
-  -- Handle :w command to accept diff changes (replaces both BufWritePost and BufWriteCmd)
-  autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufWriteCmd", {
-    group = get_autocmd_group(),
-    buffer = new_buffer,
-    callback = function()
-      M._resolve_diff_as_saved(tab_name, new_buffer)
-      -- Prevent actual file write since we're handling it through MCP
-      return true
-    end,
-  })
+  -- -- Handle :w command to accept diff changes (replaces both BufWritePost and BufWriteCmd)
+  -- autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufWriteCmd", {
+  --   group = get_autocmd_group(),
+  --   buffer = new_buffer,
+  --   callback = function()
+  --     M._resolve_diff_as_saved(tab_name, new_buffer)
+  --     -- Prevent actual file write since we're handling it through MCP
+  --     return true
+  --   end,
+  -- })
 
   -- Buffer deletion monitoring for rejection (multiple events to catch all deletion methods)
 
-  -- BufDelete: When buffer is deleted with :bdelete, :bwipeout, etc.
-  autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufDelete", {
-    group = get_autocmd_group(),
-    buffer = new_buffer,
-    callback = function()
-      M._resolve_diff_as_rejected(tab_name)
-    end,
-  })
-
-  -- BufUnload: When buffer is unloaded (covers more scenarios)
-  autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufUnload", {
-    group = get_autocmd_group(),
-    buffer = new_buffer,
-    callback = function()
-      M._resolve_diff_as_rejected(tab_name)
-    end,
-  })
-
-  -- BufWipeout: When buffer is wiped out completely
-  autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufWipeout", {
-    group = get_autocmd_group(),
-    buffer = new_buffer,
-    callback = function()
-      M._resolve_diff_as_rejected(tab_name)
-    end,
-  })
+  -- -- BufDelete: When buffer is deleted with :bdelete, :bwipeout, etc.
+  -- autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufDelete", {
+  --   group = get_autocmd_group(),
+  --   buffer = new_buffer,
+  --   callback = function()
+  --     M._resolve_diff_as_rejected(tab_name)
+  --   end,
+  -- })
+
+  -- -- BufUnload: When buffer is unloaded (covers more scenarios)
+  -- autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufUnload", {
+  --   group = get_autocmd_group(),
+  --   buffer = new_buffer,
+  --   callback = function()
+  --     M._resolve_diff_as_rejected(tab_name)
+  --   end,
+  -- })
+
+  -- -- BufWipeout: When buffer is wiped out completely
+  -- autocmd_ids[#autocmd_ids + 1] = vim.api.nvim_create_autocmd("BufWipeout", {
+  --   group = get_autocmd_group(),
+  --   buffer = new_buffer,
+  --   callback = function()
+  --     M._resolve_diff_as_rejected(tab_name)
+  --   end,
+  -- })
 
   -- Note: We intentionally do NOT monitor old_buffer for deletion
   -- because it's the actual file buffer and shouldn't trigger diff rejection
@@ -892,7 +1034,7 @@ end
 ---@param tab_name string The diff identifier
 ---@param is_new_file boolean Whether this is a new file (doesn't exist yet)
 ---@param terminal_win_in_new_tab NvimWin|nil Terminal window in new tab if created
----@param existing_buffer NvimBuf|nil Existing buffer for the file if already loaded
+---@param existing_buffer NvimBuf|nil Existing buffer for the file if already loaded (unused, kept for compatibility)
 ---@return DiffLayoutInfo layout Info about the created diff layout
 function M._create_diff_view_from_window(
   target_window,
@@ -903,73 +1045,35 @@ function M._create_diff_view_from_window(
   terminal_win_in_new_tab,
   existing_buffer
 )
-  local original_buffer_created_by_plugin = false
-
-  -- If no target window provided, create a new window in suitable location
-  if not target_window then
-    if terminal_win_in_new_tab then
-      -- We're already in the main area after display_terminal_in_new_tab
-      target_window = vim.api.nvim_get_current_win()
-    else
-      -- Try to create a new window in the main area
-      vim.cmd("wincmd t") -- Go to top-left
-      vim.cmd("wincmd l") -- Move right (to middle if layout is left|middle|right)
-
-      local buf = vim.api.nvim_win_get_buf(vim.api.nvim_get_current_win())
-      local buftype = vim.api.nvim_buf_get_option(buf, "buftype")
-      local filetype = vim.api.nvim_buf_get_option(buf, "filetype")
-
-      if buftype == "terminal" or buftype == "prompt" or filetype == "neo-tree" or filetype == "snacks_picker_list" then
-        create_split()
-      end
-
-      target_window = vim.api.nvim_get_current_win()
-    end
-  else
-    vim.api.nvim_set_current_win(target_window)
-  end
-
-  -- Decide window placement for the original file
-  local choice = choose_original_window(target_window, old_file_path, is_new_file, terminal_win_in_new_tab)
-
-  local original_window
-  if choice.decision == "split" then
-    vim.api.nvim_set_current_win(target_window)
-    create_split()
-    original_window = vim.api.nvim_get_current_win()
-  else
-    original_window = choice.original_win
-  end
-
-  -- For new files, prefer reusing an existing empty buffer in the chosen window
-  local original_buffer
-  if is_new_file and choice.reused_buf and vim.api.nvim_buf_is_valid(choice.reused_buf) then
-    original_buffer = choice.reused_buf
-    original_buffer_created_by_plugin = false
-  else
-    if is_new_file then
-      original_buffer_created_by_plugin = true
-    end
-    -- Load the original-side buffer into the chosen window
-    original_buffer = load_original_buffer(original_window, old_file_path, is_new_file, existing_buffer)
-  end
-
-  -- Set up the proposed buffer and finalize the diff layout
-  local new_win = setup_new_buffer(
-    original_window,
-    original_buffer,
+  -- Suppress unused variable warnings
+  local _ = target_window and is_new_file and terminal_win_in_new_tab and existing_buffer
+
+  -- Save files to ~/.vim/claude for codediff.nvim integration
+  -- Does NOT open diff view - user calls ClaudeCodeOpenCodeDiff for that
+  local success, err = setup_new_buffer(
+    nil, -- original_win (unused)
+    nil, -- original_buf (unused)
     new_buffer,
     old_file_path,
     tab_name,
-    terminal_win_in_new_tab,
-    target_window
+    nil, -- terminal_win_in_new_tab (unused)
+    nil -- target_win_for_meta (unused)
   )
 
+  if not success then
+    error({
+      code = -32000,
+      message = "Failed to save diff files",
+      data = err,
+    })
+  end
+
+  -- Return minimal info - no windows/buffers created for diff view
   return {
-    new_window = new_win,
-    target_window = original_window,
-    original_buffer = original_buffer,
-    original_buffer_created_by_plugin = original_buffer_created_by_plugin,
+    new_window = nil,
+    target_window = nil,
+    original_buffer = nil,
+    original_buffer_created_by_plugin = false,
   }
 end
 
@@ -1016,14 +1120,14 @@ function M._cleanup_diff_state(tab_name, reason)
     if terminal_ok and diff_data.had_terminal_in_original then
       pcall(terminal_module.ensure_visible)
       -- And restore its configured width if it is visible
-      local terminal_win = find_claudecode_terminal_window()
-      if terminal_win and vim.api.nvim_win_is_valid(terminal_win) then
-        local terminal_config = config.terminal or {}
-        local split_width = terminal_config.split_width_percentage or 0.30
-        local total_width = vim.o.columns
-        local terminal_width = math.floor(total_width * split_width)
-        pcall(vim.api.nvim_win_set_width, terminal_win, terminal_width)
-      end
+      -- local terminal_win = find_claudecode_terminal_window()
+      -- if terminal_win and vim.api.nvim_win_is_valid(terminal_win) then
+      --   local terminal_config = config.terminal or {}
+      --   local split_width = terminal_config.split_width_percentage or 0.30
+      --   local total_width = vim.o.columns
+      --   local terminal_width = math.floor(total_width * split_width)
+      --   pcall(vim.api.nvim_win_set_width, terminal_win, terminal_width)
+      -- end
     end
   else
     -- Close new diff window if still open (only if not in a new tab)
@@ -1038,15 +1142,15 @@ function M._cleanup_diff_state(tab_name, reason)
       end)
     end
 
-    -- After closing the diff in the same tab, restore terminal width if visible
-    local terminal_win = find_claudecode_terminal_window()
-    if terminal_win and vim.api.nvim_win_is_valid(terminal_win) then
-      local terminal_config = config.terminal or {}
-      local split_width = terminal_config.split_width_percentage or 0.30
-      local total_width = vim.o.columns
-      local terminal_width = math.floor(total_width * split_width)
-      pcall(vim.api.nvim_win_set_width, terminal_win, terminal_width)
-    end
+    -- -- After closing the diff in the same tab, restore terminal width if visible
+    -- local terminal_win = find_claudecode_terminal_window()
+    -- if terminal_win and vim.api.nvim_win_is_valid(terminal_win) then
+    --   local terminal_config = config.terminal or {}
+    --   local split_width = terminal_config.split_width_percentage or 0.30
+    --   local total_width = vim.o.columns
+    --   local terminal_width = math.floor(total_width * split_width)
+    --   pcall(vim.api.nvim_win_set_width, terminal_win, terminal_width)
+    -- end
   end
 
   -- ALWAYS clean up buffers regardless of tab mode (fixes buffer leak)
@@ -1400,33 +1504,49 @@ function M.reload_file_buffers_manual(file_path, original_cursor_pos)
   return reload_file_buffers(file_path, original_cursor_pos)
 end
 
+---Open the latest diff with codediff.nvim
+---Uses :CodeDiff file <original> <proposed> command
+function M.open_code_diff()
+  if not latest_diff then
+    vim.notify("No diff available to open", vim.log.levels.WARN)
+    return
+  end
+
+  local cmd = string.format("CodeDiff file %s %s", latest_diff.old_file_path, latest_diff.proposed_path)
+  vim.cmd(cmd)
+end
+
 ---Accept the current diff (user command version)
----This function reads the diff context from buffer variables
+---Reads the proposed content from the temp file and sends to Claude via MCP
 function M.accept_current_diff()
-  local current_buffer = vim.api.nvim_get_current_buf()
-  local tab_name = vim.b[current_buffer].claudecode_diff_tab_name
-
-  if not tab_name then
-    vim.notify("No active diff found in current buffer", vim.log.levels.WARN)
+  if not latest_diff then
+    vim.notify("No active diff found", vim.log.levels.WARN)
     return
   end
 
-  M._resolve_diff_as_saved(tab_name, current_buffer)
+  M._resolve_diff_as_saved(latest_diff.tab_name)
+  -- Delete the proposed file if it still exists
+  if latest_diff.proposed_path then
+    os.remove(latest_diff.proposed_path)
+  end
+  latest_diff = nil
 end
 
 ---Deny/reject the current diff (user command version)
----This function reads the diff context from buffer variables
+---Sends rejection to Claude via MCP
 function M.deny_current_diff()
-  local current_buffer = vim.api.nvim_get_current_buf()
-  local tab_name = vim.b[current_buffer].claudecode_diff_tab_name
-
-  if not tab_name then
-    vim.notify("No active diff found in current buffer", vim.log.levels.WARN)
+  if not latest_diff then
+    vim.notify("No active diff found", vim.log.levels.WARN)
     return
   end
 
-  -- Do not close windows/tabs here; just mark as rejected.
+  local tab_name = latest_diff.tab_name
   M._resolve_diff_as_rejected(tab_name)
+  -- Delete the proposed file if it still exists
+  if latest_diff.proposed_path then
+    os.remove(latest_diff.proposed_path)
+  end
+  latest_diff = nil
 end
 
 return M
diff --git a/lua/claudecode/init.lua b/lua/claudecode/init.lua
index c4b7744..00f2063 100644
--- a/lua/claudecode/init.lua
+++ b/lua/claudecode/init.lua
@@ -298,7 +298,7 @@ function M.send_at_mention(file_path, start_line, end_line, context)
         -- Open focuses the terminal without toggling/hiding if already focused
         terminal.open()
       else
-        terminal.ensure_visible()
+        -- terminal.ensure_visible()
       end
     end
     return success, error_msg
@@ -1042,6 +1042,20 @@ function M._create_commands()
     desc = "Deny/reject the current diff changes",
   })
 
+  vim.api.nvim_create_user_command("ClaudeCodeOpenCodeDiff", function()
+    local diff = require("claudecode.diff")
+    diff.open_code_diff()
+  end, {
+    desc = "Open the latest diff with codediff.nvim",
+  })
+
+  vim.api.nvim_create_user_command("ClaudeCodeNotificationDismiss", function()
+    local diff = require("claudecode.diff")
+    diff.dismiss_notification()
+  end, {
+    desc = "Dismiss the Claude Code diff notification window",
+  })
+
   vim.api.nvim_create_user_command("ClaudeCodeSelectModel", function(opts)
     local cmd_args = opts.args and opts.args ~= "" and opts.args or nil
     M.open_with_model(cmd_args)
diff --git a/lua/claudecode/selection.lua b/lua/claudecode/selection.lua
index 9bbfed9..986ec86 100644
--- a/lua/claudecode/selection.lua
+++ b/lua/claudecode/selection.lua
@@ -129,7 +129,9 @@ function M.update_selection()
   local buf_name = vim.api.nvim_buf_get_name(current_buf)
 
   -- If the buffer name starts with "term://" and contains "claude", do not update selection
-  if buf_name and buf_name:match("^term://") and buf_name:lower():find("claude", 1, true) then
+  if (buf_name and buf_name:match("^term://") and buf_name:lower():find("claude", 1, true))
+        or require("piston.editorapi").aicoder_is_diff_bufname(buf_name)
+    then
     -- Optionally, cancel demotion timer like for the terminal
     if M.state.demotion_timer then
       M.state.demotion_timer:stop()
diff --git a/lua/claudecode/terminal/native.lua b/lua/claudecode/terminal/native.lua
index 7cd24dd..c9c3d97 100644
--- a/lua/claudecode/terminal/native.lua
+++ b/lua/claudecode/terminal/native.lua
@@ -53,15 +53,17 @@ local function open_terminal(cmd_string, env_table, effective_config, focus)
   if is_valid() then -- Should not happen if called correctly, but as a safeguard
     if focus then
       -- Focus existing terminal: switch to terminal window and enter insert mode
-      vim.api.nvim_set_current_win(winid)
-      vim.cmd("startinsert")
+            -- BROKEN !!!
+      -- vim.api.nvim_set_current_win(winid)
+      -- vim.cmd("startinsert")
     end
     -- If focus=false, preserve user context by staying in current window
     return true
   end
 
   local original_win = vim.api.nvim_get_current_win()
-  local width = math.floor(vim.o.columns * effective_config.split_width_percentage)
+  -- local width = 30
+  -- local width = math.floor((vim.o.columns-30) * effective_config.split_width_percentage)
   local full_height = vim.o.lines
   local placement_modifier
 
@@ -71,7 +73,7 @@ local function open_terminal(cmd_string, env_table, effective_config, focus)
     placement_modifier = "botright "
   end
 
-  vim.cmd(placement_modifier .. width .. "vsplit")
+  vim.cmd(placement_modifier .. "vsplit")
   local new_winid = vim.api.nvim_get_current_win()
   vim.api.nvim_win_set_height(new_winid, full_height)
 
@@ -136,8 +138,8 @@ local function open_terminal(cmd_string, env_table, effective_config, focus)
 
   if focus then
     -- Focus the terminal: switch to terminal window and enter insert mode
-    vim.api.nvim_set_current_win(winid)
-    vim.cmd("startinsert")
+    -- vim.api.nvim_set_current_win(winid)
+    -- vim.cmd("startinsert")
   else
     -- Preserve user context: return to the window they were in before terminal creation
     vim.api.nvim_set_current_win(original_win)
@@ -162,10 +164,11 @@ local function close_terminal()
 end
 
 local function focus_terminal()
-  if is_valid() then
-    vim.api.nvim_set_current_win(winid)
-    vim.cmd("startinsert")
-  end
+    -- this is SO broken we just disable it
+  -- if is_valid() then
+  --   vim.api.nvim_set_current_win(winid)
+  --   vim.cmd("startinsert")
+  -- end
 end
 
 local function is_terminal_visible()
@@ -216,7 +219,7 @@ local function show_hidden_terminal(effective_config, focus)
   local original_win = vim.api.nvim_get_current_win()
 
   -- Create a new window for the existing buffer
-  local width = math.floor(vim.o.columns * effective_config.split_width_percentage)
+  -- local width = math.floor(vim.o.columns * effective_config.split_width_percentage)
   local full_height = vim.o.lines
   local placement_modifier
 
@@ -226,7 +229,7 @@ local function show_hidden_terminal(effective_config, focus)
     placement_modifier = "botright "
   end
 
-  vim.cmd(placement_modifier .. width .. "vsplit")
+  vim.cmd(placement_modifier .. "vsplit")
   local new_winid = vim.api.nvim_get_current_win()
   vim.api.nvim_win_set_height(new_winid, full_height)
 
@@ -236,8 +239,9 @@ local function show_hidden_terminal(effective_config, focus)
 
   if focus then
     -- Focus the terminal: switch to terminal window and enter insert mode
-    vim.api.nvim_set_current_win(winid)
-    vim.cmd("startinsert")
+        -- BROKEN !!!
+    -- vim.api.nvim_set_current_win(winid)
+    -- vim.cmd("startinsert")
   else
     -- Preserve user context: return to the window they were in before showing terminal
     vim.api.nvim_set_current_win(original_win)
diff --git a/lua/claudecode/terminal/snacks.lua b/lua/claudecode/terminal/snacks.lua
index 2b4c7c9..e9b4807 100644
--- a/lua/claudecode/terminal/snacks.lua
+++ b/lua/claudecode/terminal/snacks.lua
@@ -104,7 +104,7 @@ function M.open(cmd_string, env_table, config, focus)
         if term_buf_id and vim.api.nvim_buf_get_option(term_buf_id, "buftype") == "terminal" then
           if terminal.win and vim.api.nvim_win_is_valid(terminal.win) then
             vim.api.nvim_win_call(terminal.win, function()
-              vim.cmd("startinsert")
+              -- vim.cmd("startinsert")
             end)
           end
         end
@@ -118,7 +118,7 @@ function M.open(cmd_string, env_table, config, focus)
           -- Check if window is valid before calling nvim_win_call
           if terminal.win and vim.api.nvim_win_is_valid(terminal.win) then
             vim.api.nvim_win_call(terminal.win, function()
-              vim.cmd("startinsert")
+              -- vim.cmd("startinsert")
             end)
           end
         end
@@ -229,7 +229,7 @@ function M.focus_toggle(cmd_string, env_table, config)
       if terminal.buf and vim.api.nvim_buf_is_valid(terminal.buf) then
         if vim.api.nvim_buf_get_option(terminal.buf, "buftype") == "terminal" then
           vim.api.nvim_win_call(claude_term_neovim_win_id, function()
-            vim.cmd("startinsert")
+            -- vim.cmd("startinsert")
           end)
         end
       end
diff --git a/lua/claudecode/tools/get_current_selection.lua b/lua/claudecode/tools/get_current_selection.lua
index 48eefc3..47b1769 100644
--- a/lua/claudecode/tools/get_current_selection.lua
+++ b/lua/claudecode/tools/get_current_selection.lua
@@ -41,7 +41,7 @@ local function handler(params)
     local current_buf = vim.api.nvim_get_current_buf()
     local buf_name = vim.api.nvim_buf_get_name(current_buf)
 
-    if not buf_name or buf_name == "" then
+    if not buf_name or buf_name == "" or require("piston.editorapi").aicoder_is_diff_bufname(buf_name) then
       -- No active editor case - match VS Code format
       local no_editor_response = {
         success = false,
diff --git a/plugin/claudecode.lua b/plugin/claudecode.lua
index 5248095..b8fda58 100644
--- a/plugin/claudecode.lua
+++ b/plugin/claudecode.lua
@@ -1,21 +1,8 @@
-if vim.fn.has("nvim-0.8.0") ~= 1 then
-  vim.api.nvim_err_writeln("Claude Code requires Neovim >= 0.8.0")
-  return
-end
-
 if vim.g.loaded_claudecode then
   return
 end
 vim.g.loaded_claudecode = 1
 
---- Example: In your `init.lua`, you can set `vim.g.claudecode_auto_setup = { auto_start = true }`
---- to automatically start ClaudeCode when Neovim loads.
-if vim.g.claudecode_auto_setup then
-  vim.defer_fn(function()
-    require("claudecode").setup(vim.g.claudecode_auto_setup)
-  end, 0)
-end
-
 -- Commands are now registered in lua/claudecode/init.lua's _create_commands function
 -- when require("claudecode").setup() is called.
 -- This file (plugin/claudecode.lua) is primarily for the load guard
